"""Test of linearized cosmology with only CDM fluid

Authors: G. Peairs <gpeairs@stanford.edeu>
Affiliation: KIPAC/SLAC/Stanford
License:
  Copyright (C) 2011 J. S. Oishi, G. Peairs.  All Rights Reserved.

  This file is part of dedalus.

  dedalus is free software; you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation; either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
"""

from dedalus.mods import *
import numpy as na
import sys

if len(sys.argv) != 2:
    print "usage: ", sys.argv[0], " <normalization data file>"
    print """sample ic and normalization data is included in file norm_input.txt (generated by linger++, transfer-mode output)
"""
    print "using sample data..."
    normfname = 'norm_input.txt'
else:
    normfname = sys.argv[1]

shape = (10,10,10)
RHS = LinearCollisionlessCosmology(shape, FourierRepresentation)
data = RHS.create_fields(0.)
RHS.parameters['Omega_r'] = 8.4e-5
RHS.parameters['Omega_m'] = 0.276
RHS.parameters['Omega_l'] = 0.724
RHS.parameters['H0'] = 7.185e-5 # 70.3 km/s/Mpc in Myr

spec_delta, spec_u = cosmo_spectra(data, normfname)
collisionless_cosmo_fields(data['delta'], data['u'], spec_delta, spec_u)

ti = RK4simplevisc(RHS)
ti.stop_time(1000)
ti.set_nsnap(100)
ti.set_dtsnap(1000)
dt = 1 # time in Myr

outfile = open('growth.dat','w')

delta_init = na.zeros_like(data['delta']['kspace'])
ti.advance(data, dt) 
# May need to advance more for the decaying mode to vanish completely
delta_init[:] = data['delta']['kspace']
while ti.ok:
    ti.advance(data, dt)
    delta = data['delta']['kspace'][1,1,1].real
    outfile.write("%10.5e\t%10.5e\t%10.5e\n" %(ti.time, ti.RHS.aux_eqns['a'].value, delta))
outfile.close()

delta_final = data['delta']['kspace'] 
#print delta_final/delta_init
#Should be a single real number for all modes, assuming the decaying
#solution is negligible in delta_init
